library(data.table)
library(plotly)
options(width = 150)

dp <- setDT(read.csv('dp.csv'))
cancel_dealer <- setDT(read.csv('cancel_dealer.csv'))
head(cancel_dealer)
cancel_dealer$filedate <- as.Date(cancel_dealer$date_cancelled, tryFormats="%m/%d/%y")
dp$filedate <- as.Date(as.character(dp$filedate))
fullData <- merge(dp, cancel_dealer, by = c('filedate', 'dealer_legacy_id'))

fullData <- na.omit(fullData)
hist(fullData$roi_value_30_day)
fullData$roi_value_30_day <- ifelse(fullData$roi_value_30_day >= 10, 10, fullData$roi_value_30_day)
hist(fullData$roi_value_30_day)
hist(fullData$roi_value_30_day, main = "Distribution of ROI for Cancelled Dealers", xlab = "Rolling 30 Days ROI on the Day of Cancel Request")

# select
#   dp.filedate,
#   dp.dealer_legacy_id,
#   dp.franchise_independent,
#   dp.roi_value_30_day,
#   dp.total_spend_30_day,
#   dp.email_lead_quality_30_day
# from insight.dealer_predictions dp
# where dp.dealer_legacy_id in ('158407','5393788','197221','4874','5387723','147444','5392442','203608','5357431','116','5388076','151623','21904','104265','5372427','185535','150651','184866','5378962','208611','5392755','185313','185725','5370647','10036','9450','107092','209665','110780','9746','5383852','181858','5383853','5363836','5392997','193584','107882','4183','5366613','5391398','206165','5389237','147970','180959','159635','5343143','5367298','157291','5372258','5391680','5371441','207485','5391079','5385654','202764','5392268','5327789','5382247','200993','5342858','5393344','158030','202060','153349','124','5392240','157138','5368262','3997','198851','5387144','5394037','195978','198347','5375501','5385767','165536','5370077','189379','5244220','181807','211606','158202','5355883','161121','204707','2401026','183661','5354866','25112','5369620','2442357','108464','5343550','5383957','5383957','5391767','5386230','23856','5391264','148640','185262','5394196','5362384','158212','5243326','5371509','5392854','5388302','183326','5392749','5388558','155242','5381077','5348421','5368312','152264','5243024','104579','5373066','5385900','1436','5393016','2351495','95321','5390726','157124','5391717','5377665','5382034','5382121','5389691','194393','6630','185247','5378','207676','13837','5373166','23466','15474','156931','5372835','5388169','5392368','5392702','5355853','2455626','5392109','92880','179770','5391375','162337','210843','193791','5368089','5376138','5389703','26571','5389260','83098','12137','150759','25470','5373513','5366227','87135','156755','5381694','157612','5393404','204333','2583192','192745','5393','154497','2183185','24406','5386','183362','5365121','188487','199444','5393652','13030','5394056','7888','2288574','198622','5394060','191345','5392893','5387175','5390197','179593','5391468','5393417','157730','190503','5354878','5385637','148620','201579','5377590','13383','5392598','185883','5373037','152308','5385235','5368346','202517','5391837','14472','6373','5242663','5242683','2479168','80866','5391217','2186601','5367305','201947','5362403','6377','6376','11827','207135','153194','5390983','2316006','152052','150387','5351202','5250409','5342466','5377385','973','101333','24726','202387','5061','149312','2269378','151896','5384433','5357906','202869','10642','16921','16904','16853','198750','16846','201336','5249427','5390195','5385254','5390965','5243480','25442','5385855','20193','163495','5369643','5343467','5327440','158263','5391900','5376819','4198','192166','195290','18211','189669','4946','88526','210999','106831','179377','5381627','5392251','2359','5344407','261','147051','110656','2359902','184567','5392058','207716','190654','5333000','201382','5383066','174597','5391213','104438','106379','5363881','5247380','5391715','5393104','5388130','5388130','21667','21694','5244227','22742','4409','5362634','5358253','5358252','5224088','87623','2388880','81003')
# and dp.filedate >= '2020-07-01' ;
