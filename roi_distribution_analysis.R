#roi_distribution_analysis.R
library(data.table)
library(plotly)
library(readr)
library(ggplot2)
library(scales)
options(width = 150)
roi_data <- setDT(read_csv("dealer_roi_dist.csv"))
head(roi_data)
roi_data <- roi_data[!is.na(median_roi_value_30_day)]
roi_data$median_roi_value_30_day <- ifelse(roi_data$median_roi_value_30_day >= 50, 50, roi_data$median_roi_value_30_day)
roi_data$avg_roi_value_30_day <- ifelse(roi_data$avg_roi_value_30_day >= 50, 50, roi_data$avg_roi_value_30_day)
hist(roi_data[,median_roi_value_30_day], xlab = "ROI", main = "Distribution of ROI")
roi_data$status <- ifelse(roi_data$requested_cancel == 1, 'Cancelled', 'Active')

# Density plots
ggplot(roi_data, aes(x = median_roi_value_30_day, colour=status)) + geom_density() +
  scale_fill_continuous(type = "viridis") +
  theme_bw() + labs(title="Distribution of ROI (30 Days) for Dealers \n That Cancelled versus Not",
        x ="Rolling 30 Days ROI", y = "Density")

ggplot(roi_data, aes(x = median_roi_value_30_day, colour=franchise_independent)) + geom_density() +
  scale_fill_continuous(type = "viridis") +
  theme_bw() + labs(title="Distribution of ROI (30 Days) for Dealers \n That Cancelled versus Not",
        x ="Rolling 30 Days ROI", y = "Density")

roi_data$roi_30_group <- NULL
roi_data$roi_30_group <- "50X+"
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day <= 1, "0X-1X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 1 & roi_data$median_roi_value_30_day <= 3, "1X-3X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 3 & roi_data$median_roi_value_30_day <= 5, "3X-5X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 5 & roi_data$median_roi_value_30_day <= 10, "5X-10X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 10 & roi_data$median_roi_value_30_day < 50, "10X-50X", roi_data$roi_30_group)
roi_data$roi_30_group <- ordered(roi_data$roi_30_group, levels = c("0X-1X", "1X-3X", "3X-5X", "5X-10X", "10X-50X", "50X+"))

roi_data$roi_30_group <- NULL
roi_data$roi_30_group <- "50X+"
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day <= 3, "0X-3X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 3 & roi_data$median_roi_value_30_day <= 5, "3X-5X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 5 & roi_data$median_roi_value_30_day <= 10, "5X-10X", roi_data$roi_30_group)
roi_data$roi_30_group <- ifelse(roi_data$median_roi_value_30_day > 10 & roi_data$median_roi_value_30_day < 50, "10X-50X", roi_data$roi_30_group)
roi_data$roi_30_group <- ordered(roi_data$roi_30_group, levels = c("0X-3X", "3X-5X", "5X-10X", "10X-50X", "50X+"))

aggData <- roi_data[, .(
      n_dealers = .N,
      per_dealers = round(.N/nrow(roi_data)*100, 2),
      churn_rate = round(sum(requested_cancel)/nrow(roi_data)*100, 2)
), by = list(roi_30_group)][order(roi_30_group)]

allDealers <- ggplot(aggData) +
  geom_col(aes(x = roi_30_group, y = churn_rate), size = 0.75, color = "darkblue", fill = "white") +
  scale_fill_continuous(type = "viridis") +
  theme_bw() + labs(title="Churn Rate (in %) across ROI based Dealers Groups for All Dealers",
        x ="ROI Group", y = "Churn Rate (%)") +
  geom_text(size = 3, aes(x = roi_30_group,
  y = churn_rate + 0.05, label = paste("Churn Rate: ", round(churn_rate, 2), "%\n Total Dealers: ", n_dealers, sep = "")))
allDealers

aggData <- roi_data[franchise_independent == "Franchise", .(
      n_dealers = .N,
      per_dealers = round(.N/nrow(roi_data)*100, 2),
      churn_rate = round(sum(requested_cancel)/nrow(roi_data)*100, 2)
), by = list(roi_30_group)][order(roi_30_group)]
fDealers <- ggplot(aggData) +
  geom_col(aes(x = roi_30_group, y = churn_rate), size = 0.75, color = "darkblue", fill = "white") +
  scale_fill_continuous(type = "viridis") +
  theme_bw() + labs(title="Churn Rate (in %) across ROI based Dealers Groups for Franchise Dealers",
        x ="ROI Group", y = "Churn Rate (%)") +
  geom_text(size = 3, aes(x = roi_30_group,
  y = churn_rate + 0.05, label = paste("Churn Rate: ", round(churn_rate, 2), "%\n Total Dealers: ", n_dealers, sep = "")))
fDealers

aggData <- roi_data[franchise_independent == "Independent", .(
      n_dealers = .N,
      per_dealers = round(.N/nrow(roi_data)*100, 2),
      churn_rate = round(sum(requested_cancel)/nrow(roi_data)*100, 2)
), by = list(roi_30_group)][order(roi_30_group)]
iDealers <- ggplot(aggData) +
  geom_col(aes(x = roi_30_group, y = churn_rate), size = 0.75, color = "darkblue", fill = "white") +
  scale_fill_continuous(type = "viridis") +
  theme_bw() + labs(title="Churn Rate (in %) across ROI based Dealers Groups for Independent Dealers",
        x ="ROI Group", y = "Churn Rate (%)") +
  geom_text(size = 3, aes(x = roi_30_group,
  y = churn_rate + 0.05, label = paste("Churn Rate: ", round(churn_rate, 2), "%\n Total Dealers: ", n_dealers, sep = "")))
iDealers


roi_data[, .(
      n_dealers = .N,
      per_dealers = round(.N/nrow(roi_data)*100, 2),
      churn_rate = round(sum(requested_cancel)/nrow(roi_data)*100, 2)
), by = list(roi_30_group, franchise_independent)][order(franchise_independent, roi_30_group)]

# select
#   da.customer_id,
#   da.franchise_independent,
#   case
#       when da.dealer_legacy_id in ('158407','5393788','197221','4874','5387723','147444','5392442','203608','5357431','116','5388076','151623','21904','104265','5372427','185535','150651','184866','5378962','208611','5392755','185313','185725','5370647','10036','9450','107092','209665','110780','9746','5383852','181858','5383853','5363836','5392997','193584','107882','4183','5366613','5391398','206165','5389237','147970','180959','159635','5343143','5367298','157291','5372258','5391680','5371441','207485','5391079','5385654','202764','5392268','5327789','5382247','200993','5342858','5393344','158030','202060','153349','124','5392240','157138','5368262','3997','198851','5387144','5394037','195978','198347','5375501','5385767','165536','5370077','189379','5244220','211606','158202','5355883','161121','204707','2401026','5354866','25112','5369620','2442357','108464','5343550','5383957','5391767','23856','5391264','148640','185262','5394196','5362384','158212','5243326','5371509','5392854','5388302','183326','5392749','5388558','155242','5381077','5348421','5368312','152264','5243024','5373066','5385900','1436','5393016','2351495','95321','5390726','157124','5391717','5377665','5382034','5382121','5389691','194393','6630','185247','5378','207676','13837','5373166','23466','15474','156931','5372835','5388169','5392368','5392702','5355853','5392109','92880','179770','5391375','162337','210843','193791','5368089','5376138','5389703','26571','5389260','83098','150759','25470','5373513','5366227','87135','156755','5381694','157612','5393404','204333','2583192','192745','5393','154497','2183185','24406','5386','183362','5365121','188487','199444','5393652','13030','5394056','7888','2288574','198622','5394060','191345','5392893','5387175','5390197','179593','5391468','5393417','157730','190503','5385637','148620','201579','5377590','13383','5392598','185883','5373037','152308','5385235','5368346','202517','5391837','14472','6373','5242683','2479168','80866','5391217','2186601','5367305','201947','5362403','6377','6376','5385625','11827','207135','153194','5390983','2316006','152052','150387','5351202','5250409','5342466','5377385','973','101333','24726','202387','5061','149312','2269378','151896','5384433','5357906','202869','10642','16921','16904','16853','198750','16846','201336','5249427','5385254','5390965','5243480','25442','5385855','20193','163495','5369643','5343467','5327440','158263','5391900','5376819','4198','192166','195290','18211','189669','4946','88526','210999','106831','179377','5381627','5392251','2359','5344407','261','147051','110656','2359902','184567','5392058','207716','190654','5333000','201382','5383066','174597','5391213','104438','106379','5363881','5247380','5391715','5393104','5388130','5388130','21667','21694','5244227','22742','4409','5362634','5348','5371383','5358097','5394094','5364416','5358253','5358252','2388880','81003','5376906','5376924','5374531','5365039','5354797','5365040','11321','98664','5249382','189235','5372240','5393802','5357648','25852','177011','189744','5250236','190758','184836','211423','5357897','156342','5376814','5392704','5354258','5376703','5387570','5393367','184363','5382935','157617','4817','5385257','203491','12395','178060','5362815','20591','105087','104303','2402272','12355','9252','5392018','5382111','187298','5392595','5392530','179105','157950','5391246','5393676')
#           then 1
#       else 0
#   end as requested_cancel,
#   median(dp.roi_value_30_day) median_roi_value_30_day,
#   avg(dp.roi_value_30_day) avg_roi_value_30_day
# from insight.dealer_activity da
# join insight.dealer_predictions dp
#   on da.filedate = dp.filedate
#   and da.customer_id = dp.customer_id
# where da.filedate >= '2020-07-02'
#   and dp.roi_value_30_day is not null
#   and da.total_spend > 10
#   and da.dealer_legacy_id not in ('9865', '9845', '97701', '97681', '97046', '96089', '9397', '91862', '88062', '87870', '87788', '864', '85925', '85883', '85489', '84916', '84908', '83846', '82443', '8142', '8095', '8056', '80230', '7741', '7738', '7582', '69', '5789', '5756', '5752', '5646', '5616', '5610', '561', '5601', '5471', '5393081', '5393078', '5393057', '5393026', '5392981', '5392847', '5392846', '5392839', '5392829', '5392748', '5392745', '5392742', '5392740', '5392659', '5392506', '5392482', '5392420', '5392376', '5392332', '5392246', '5392102', '5392094', '5392083', '5392081', '5392075', '5392019', '5392014', '5391998', '5391978', '5391921', '5391918', '5391813', '5391798', '5391564', '5391557', '5391123', '5391103', '5391076', '5391056', '5390960', '5390923', '5390817', '5390741', '5390709', '5390396', '5390323', '5390276', '5390063', '5389825', '5389392', '5389382', '5389359', '5388840', '5388474', '5388371', '5388353', '5388270', '5388005', '5387870', '5387853', '5387799', '5387211', '5386139', '5385918', '5385312', '5385056', '5384606', '5384444', '5384429', '53844', '5384319', '5384110', '5383946', '5383870', '5383383', '5383345', '5381740', '5380792', '5380183', '5379688', '5379464', '5379295', '5379138', '5379107', '5379090', '5378185', '5377398', '5376982', '5376931', '5376784', '5376710', '5376476', '5376402', '5376347', '5376226', '5376217', '5376000', '5375961', '5375642', '5375545', '5375515', '5375322', '5374567', '5374565', '5374033', '5374018', '5373944', '5373939', '5373898', '5373884', '5373770', '5373756', '5373634', '5373581', '5373373', '5373321', '5372884', '5372780', '5372259', '5371621', '5371360', '5370646', '5370138', '5369362', '5369178', '5368986', '5368061', '5367966', '5367224', '5367129', '5366010', '5365546', '5365542', '5365038', '5364824', '5364580', '5363790', '5363601', '5363314', '5363142', '5362875', '5362715', '5362456', '5361136', '5357966', '5357799', '5357384', '5355929', '5355480', '5355297', '5354806', '5351404', '5351338', '5348827', '5348447', '5348187', '5348028', '5344569', '5344514', '5344361', '5343882', '5335297', '5334877', '5332980', '5332797', '5327921', '5327561', '5327438', '5269', '5256338', '5254158', '5253999', '5250534', '5250421', '5250377', '5250295', '5249432', '5249272', '5249102', '5249083', '5247875', '5244012', '5244008', '5243977', '5243718', '5243134', '5243116', '5242848', '5242845', '5144', '4965', '4947', '4820', '4741', '4696', '4658', '4643', '4639', '4629', '4615', '4614', '4559', '4105', '4061', '3770', '3526', '3514', '3173', '316', '2903', '27018', '26595', '26553', '25754', '25732', '25668', '25634', '2561213', '25599', '2556', '25553', '2553364', '25509', '25466', '25151', '2505679', '25', '2492043', '2491858', '2491828', '2480143', '24797', '2468482', '24293', '24234', '2422030', '24139', '24137', '24133', '2407027', '2400671', '236', '2320398', '2316999', '2314465', '23111', '23082', '2298700', '2280192', '2256883', '2248769', '22358', '22357', '22237', '2220113', '21901', '2165806', '2165642', '21602', '21464', '211075', '210289', '21022', '209365', '209227', '208836', '208610', '208488', '207734', '207104', '206935', '206915', '206787', '206452', '206073', '205901', '205827', '205004', '204847', '204377', '204009', '203869', '203768', '20375', '203284', '203150', '202732', '202084', '201356', '200401', '200193', '199930', '199874', '199832', '199733', '199727', '199262', '198878', '198390', '197573', '197481', '197042', '196384', '196048', '195341', '194934', '194242', '193652', '193378', '192440', '191863', '191642', '191509', '191010', '190697', '190080', '189549', '189529', '189390', '188929', '188673', '188591', '187679', '186867', '18627', '186039', '186', '185351', '185004', '184678', '184579', '184570', '184385', '184354', '184243', '183937', '183122', '182785', '182768', '182765', '182757', '182687', '181868', '181353', '181111', '179879', '179867', '179855', '178290', '177059', '176728', '176714', '176268', '175955', '17536', '16802', '165875', '165635', '164820', '163515', '161840', '161415', '159818', '159320', '159055', '158890', '15791', '157852', '15757', '157424', '157113', '156536', '156455', '156439', '156348', '156341', '156330', '156104', '155615', '155142', '155010', '154948', '154937', '154637', '154559', '154502', '154498', '154325', '153823', '153775', '153690', '153644', '153633', '152467', '151427')
# group by 1, 2, 3
# ;
